<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改礼品卡</title>
    <link rel="stylesheet" href="__PUBLIC__/Admin/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/Admin/css/jeDate-test.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/Admin/css/jedate.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/Admin/css/bootstrap-select.min.css">
    <script src="__PUBLIC__/Admin/js/jquery-2.1.0.js"></script>
    <script src="__PUBLIC__/Admin/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Admin/js/jquery.jedate.js"></script>
    <link href="__PUBLIC__/Admin/css/select2.min.css" rel="stylesheet" />
    <script src="__PUBLIC__/Admin/js/select2.min.js"></script>
    <script type="text/javascript" src="/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="/ueditor/ueditor.all.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Admin/js/plupload.full.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Admin/js/bootstrap-select.min.js"></script>
    <style>
        .baseinfo{padding-left:50px;font-weight:900;font-size:18px}
        .main{background-color:white;padding-top:20px}
        .redioType{margin-top:7px;}
        .redioTypeLeft{margin-top:7px;margin-left: -50px}
        .priceNum{margin-left:-55px}
        .wenzi{margin-top:8px}
        .saleNum{margin-left:-30px}
        .selectCondition{display: flex; flex-direction: row;max-width:700px;justify-content: flex-start;align-items: flex-center;flex-wrap: wrap;}
        .selectItem{margin-left:5px;border:1px solid #ff7f00;min-width: 50px;height: 28px;margin-right: 15px;margin-bottom: 15px; padding: 0 10px;display: flex;flex-direction: row;justify-content: center align-items: center;font-size: 14px;line-height:28px}
        .selectItem span{ cursor:pointer;padding-left:10px;font-size:26px;color:#446C94;font-weight:900;line-height: 24px;display:block}
        .Immutable{color:#cccccc}
    </style>
</head>
<body>
<ol class="breadcrumb">
    <li><a href="#">首页</a></li>
    <li><a href="#">礼品卡管理</a></li>
    <li class="active">修改礼品卡</li>
</ol>

<div class="container row main">
    <form action="#" method="post" class="form-horizontal">
        <div class="form-group col-sm-12 baseinfo">基础信息</div>
        <div class="form-group">
            <label for="" class="col-sm-2 control-label Immutable" >*礼品卡类型</label>
            <div class="col-sm-2" style="margin-top:7px" >
                <input type="radio" name="cardType" class="cardType" <if condition="$res.type eq 1 ">checked</if> value="1"  id="" disabled>
                <span class="Immutable">余额卡(固定金额)</span>
            </div>
            <div class="col-sm-2 redioTypeLeft">
                <input type="radio" name="cardType" class="cardType"  <if condition="$res.type eq 2 ">checked</if> value="2" id="" disabled>
                <span class="Immutable">兑换卡(兑换产品)</span>
            </div>
        </div>
        <div class="form-group">
            <label for="" class="col-sm-2 control-label" >*礼品卡名称</label>
            <div class="col-sm-6">
                <input type="text" class="form-control"  value="{$res.name}" name="name" placeholder="" id="name">
            </div>
        </div>
        <div id="exchagepic">               <!--兑换卡图片-->
            <if condition="$res.type eq 2">
                <div class="form-group cardImg" style="margin-bottom:40px;">
                    <label for="" class="col-sm-2 control-label" >*礼品卡图片</label>
                    <div class="col-sm-1" id="imgcontainer"></div>
                </div>
            </if>
        </div>

        <div class="form-group" id="discountInfo">
            <div id="cardprice">
                <if condition="$res.type eq 1">
                <label for="" class="col-sm-2 control-label Immutable" >*礼品卡面额</label>
                <div class="col-sm-2"><input type="text" class="form-control"   value="{$res.price}" name="" placeholder="" id="price" disabled></div>
                <div class="col-sm-1 wenzi Immutable">元</div>
                </if>
            </div>
            <label for="" class="col-sm-2 control-label Immutable">*发行份数</label>
            <div class="col-sm-2">
                <input type="text" class="form-control" value="{$res.num}"  name="" placeholder="输入大于1的整数" id="num" disabled>
            </div>
            <div class="col-sm-1 wenzi Immutable">份</div>
        </div>
        <div class="form-group">
            <label for="" class="col-sm-2 control-label Immutable" >*有效期</label>
            <div class="col-sm-2 redioType"  >
                <input type="radio" name="timetype" <if condition="$res.timetype eq 1 ">checked</if> class="timetype" value="1"  checked id="fixed" disabled>
                <span class="Immutable">固定日期</span>
            </div>
            <div class="col-sm-2 redioTypeLeft">
                <input type="radio" name="timetype"  <if condition="$res.timetype eq 2 ">checked</if> class="timetype" value="2" id="nNums" disabled>
                <span class="Immutable">领取后N天</span>
            </div>
        </div>
        <div class="form-group" id="valid">
            <if condition="$res.timetype eq 1">
            <label for="" class="col-sm-2 control-label" ></label>
                      <div class="col-sm-2">
                          <input type="text" class="form-control timeString" value="{$res.time}" id="fixedTime"  name="" placeholder="选择日期" disabled>
                      </div>
                       <div class="col-sm-2">
                       <sapn class="Immutable">*结束日期的当天可用</sapn>
                       </div>
                <else />
                <label for="" class="col-sm-2 control-label" ></label>
                            <div class="col-sm-1 wenzi Immutable">领取后</div>
                            <div class="col-sm-2 priceNum">
                               <input type="text" class="form-control timeString"  value="{$res.time}"   name="" placeholder="" id="endTime" disabled>
                           </div>
                           <div class="col-sm-1 wenzi Immutable">天</div>
            </if>
        </div>
        <div class="form-group">
            <label for="" class="col-sm-2 control-label">*规则描述</label>
            <div class="col-sm-4">
                <script type="text/plain" id="notes"  name="desc" style="width:375px;min-height:200px"></script>
                </div>
                <div class="col-sm-4">
                    <span>*描述在前台用户可见</span>
                    </div>
                    </div>

                    <div id='usearea'>
                    <if condition="$res.type eq 1">
                        <div class="form-group">
                        <label for="" class="col-sm-2 control-label" >*可用产品范围</label>
                        <div class="col-sm-3">
                        <select name="" class="form-control" id="usetype">
                        <option value="1" <if condition="$res.usetype eq 1">selected</if>>白名单模式（以下产品可用）</option>
                       <option value="2" <if condition="$res.usetype eq 2">selected</if>>黑名单模式（除以下产品外的产品可用）</option>
                    </select>
                    </div>
                    </div>

                <div class="form-group">
                    <label for="" class="col-sm-2 control-label" ></label>
                    <div class="col-sm-2 redioType"  >
                    <input type="radio" name="secnetype" class="isall" value="1" <if condition="$res.isall eq 1">checked</if> <if condition="$res.usetype eq 2">disabled</if>  id="allProduct">
                    <span>所有产品</span>
                    </div>
                    <div class="col-sm-2 redioTypeLeft">
                    <input type="radio" name="secnetype" class="isall" value="2" <if condition="$res.isall eq 2">checked</if> id="sectionProduct">
                    <span>部分产品</span>
                    </div>
                    </div>
                    <div  class="form-group"  id="productInfomation">
                    <if condition='$res.isall eq 2'>
                    <div class="form-group" >
                                <label for="" class="col-sm-2 control-label" ></label>
                                <div class="col-sm-2">
                                    <select  name="type"  class="form-control" id="selecttype">
                                        <option value="1">一级分类</option>
                                        <option value="2">二级分类</option>
                                        <option value="3">管家</option>
                                        <option value="4">产品</option>
                                        <option value="5">供应商</option>
                                    </select>
                                </div>
                                <div class="col-sm-3">
                                    <select name="" id="serachvalue" class="form-control"></select>
                                </div>
                                <div class="col-sm-1">
                                    <button type="button" name="" id="addButton" class="btn btn-primary sureButton" style="width:50px;background:#1AB394;border:0">添加</button>
                                </div>
                            </div>
                            <label for="" class="col-sm-2 control-label" ></label>
                            <div class="selectCondition" id="selectCondition">
                    <volist name="list" id="vo">
                    <div class="item selectItem" data-id="{$vo.id}" data-name="" data-type="{$vo.type}" data-tag="{$vo.type}-{$vo.id}"> {$vo.name}<span class="delButton">×</span></div>
                    </volist>

                    </div>

                    </if>

                    </div>
                    </if>
                </div>
                    <div class="form-group" id="totalexchange">
                        <label for="" class="col-sm-2 control-label duihuantitle" <if condition='$res.type eq 1'> style="display:none" </if>>*可兑换产品</label>
                        <div  class="col-sm-10 " id='exchange'>
                        </div>
                    </div>

                    <div class="form-group">
                    <label for="" class="col-sm-2 control-label" >*礼品卡用途</label>
                    <div class="col-sm-4">
                    <textarea type="textarea" class="form-control"   name="" placeholder="" id="info">{$res.info}</textarea>
                    </div>
                    <div class="col-sm-4">
                    <span>*系统内可见，不对用户显示</span>
                </div>
                </div>
                <div id='cardurl'>
                    <if condition="$res.type eq 1">
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label" >跳转链接</label>
                        <div class="col-sm-2" id="" style="z-index: 10000">
                        <select  name=""  class="form-control" id="urltype">
                        <option value="1" <if condition="$cardurl.type eq 1">selected</if>>无</option>
                        <option value="2" <if condition="$cardurl.type eq 2">selected</if>>首页</option>
                        <option value="3" <if condition="$cardurl.type eq 3">selected</if>>管家页</option>
                        <option value="4" <if condition="$cardurl.type eq 4">selected</if>>产品页</option>
                        <option value="5" <if condition="$cardurl.type eq 5">selected</if>>链接</option>
                        </select>
                        </div>
                        <div class="col-sm-3" id="condition">
                        <input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">
                        </div>
                        </div>
                        </if>
                    </div>

                <div class="form-group">
                    <label for="" class="col-sm-2 control-label" >礼品卡状态</label>
                    <div class="col-sm-2 redioType"  >
                    <input type="radio" name="status" class="status"  <if condition="$res.status eq '1'">checked</if> value="1"  id="">
                    <span>可以绑定</span>
                    </div>
                    <div class="col-sm-2 redioTypeLeft">
                    <input type="radio" name="status" class="status" <if condition="$res.status eq '0' ">checked</if>  value="0" id="">
                    <span>停止绑定</span>
                    </div>
                    </div>
                    <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                    <button type="button" name="" id="surebtn" class="btn btn-primary saveButton" style="width:150px;background:#1AB394;border:0">保存</button>
                    </div>
                    </div>
                    </form>
                    </div>
                    <script type="text/javascript">
                    let cssPath = '__PUBLIC__/Admin/css';
                </script>
                <script type="text/javascript" src="__PUBLIC__/Admin/js/ueditorX.js"></script>
                <script>

                     //上传图片操作
                    function strpic(url,oneimageclass) {
                        var str = '<div style="display:inline-block;height: 110px;width:110px;margin-right: 10px" data-path="'+url+'" class="'+oneimageclass+'"><img src="https://file.rose52.com'+url+'"  alt="" width="110" height="110" path="'+url+'" style="margin-top: 15px;margin-left: 10px;float: left;"><div  class="del" style="fload:right;margin-top:0px;margin-left:111px;color:red;font-size: 18px;font-weight: bold;width: 20px;height: 20px; cursor: pointer" path="'+url+'">x</div></div>';
                        return str;
                    }
                    var uploadTicket = {policy:null,authorization:null,bucket:null};
                    $.post("{:U('AjaxApi/Upyun/getUpyunPolicyAndAuthorization')}",{},function (res) {
                        uploadTicket.policy = res.policy;
                        uploadTicket.authorization = res.authorization;
                        uploadTicket.bucket = res.bucket;
                        var uploadcontainer1 = 'imgcontainer';
                        var initpic1 = '{$res.cardpic}';
                        createUploadStr(uploadcontainer1,1,initpic1);

                    },'json');
                    // 删除
                    $(document).on('click','.del', function () {
                        var path = $(this).attr('path');
                        var uploadcontainer = $(this).parent().parent().attr('id');
                        var nowimgNum = $("."+uploadcontainer).length;
                        $(this).parent().remove();
                        var nowpath = uploadpathstr(uploadcontainer);
                        console.log(path);
                        var maxPicNum = parseInt($("#"+uploadcontainer).attr("maxpicnum"));
                        if (nowpath == ''&& !($("."+uploadcontainer+'Pupload').length)) {
                            createUploadStr(uploadcontainer, maxPicNum, '');
                        } else if(maxPicNum == nowimgNum){
                            createUploadStr(uploadcontainer, maxPicNum, '');
                        }

                    })
                    function uploadpathstr(uploadcontainer) {
                        var nowpath = '';
                        $("."+uploadcontainer).each(function () {
                            var path = $(this).attr('data-path');
                            nowpath +=path+",";
                        })
                        nowpath = nowpath.substr(0,nowpath.length-1);
                        $("#"+uploadcontainer).attr('uploadpath', nowpath);
                        return nowpath;
                    }
                    function createUploadStr(uploadcontainer,maxPicNum,initpic) {
                        var timestamp = Date.parse(new Date());
                        var uploadid = uploadcontainer+timestamp;
                        var imgstr = '<div class="'+uploadcontainer+'Pupload" style="display:inline-block;height: 115px;width:110px;margin-right: 10px" id="parent'+uploadid+'" ><img id="'+uploadid+'" src="__PUBLIC__/Admin/images/addpic.jpg"  alt="" width="100" height="100" style="margin-top: 15px;margin-left: 10px;float: left;"><div style="fload:right;margin-top:0px;margin-left:110px;color:red;font-size: 18px;font-weight: bold;">&nbsp;</div></div>'
                        $("#"+uploadcontainer).attr("maxpicnum",maxPicNum);
                        if (initpic != '' && initpic != undefined) {
                            $("#"+uploadcontainer).attr('uploadpath',initpic);
                            initpic = initpic.split(',');
                            var tempstr = '';
                            for (var i = 0; i < initpic.length; i++) {
                                tempstr += strpic(initpic[i], uploadcontainer);
                            }
                            $("#"+uploadcontainer).append(tempstr);
                            if (initpic.length < maxPicNum) {
                                $("#"+uploadcontainer).append(imgstr);
                                createPuoload(uploadcontainer,uploadid,maxPicNum);
                            }
                        } else {
                            $("#"+uploadcontainer).append(imgstr);
                            createPuoload(uploadcontainer,uploadid,maxPicNum);
                        }

                    }

                    function createPuoload(uploadcontainer,uploadid,maxPicNum) {
                        var  uploader = new plupload.Uploader({
                            browse_button : uploadid, //触发文件选择对话框的按钮，为那个元素id
                            url : 'https://v0.api.upyun.com/' + uploadTicket.bucket, //服务器端的上传页面地址
                            filters: {
                                mime_types: [
                                    {title: 'Image files', extensions: 'jpg,gif,png,jpeg'}
                                ],
                                prevent_duplicates: true // 不允许选取重复文件
                            },
                            multipart: true,
                            multipart_params: {
                                'Filename': '${random}', // adding this to keep consistency across the runtimes
                                'Content-Type': '',
                                'policy': uploadTicket.policy,
                                'authorization': uploadTicket.authorization
                                /*'signature': '<?php echo $signature; ?>' */
                            },
                            flash_swf_url : 'js/Moxie.swf', //swf文件，当需要使用swf方式进行上传时需要配置该参数
                            silverlight_xap_url : 'js/Moxie.xap' //silverlight文件，当需要使用silverlight方式进行上传时需要配置该参数
                        });

                        //在实例对象上调用init()方法进行初始化
                        uploader.init();

                        //绑定各种事件，并在事件监听函数中做你想做的事
                        uploader.bind('FilesAdded',function(uploader,files){
                            var nownum = $("."+uploadcontainer).length;
                            var reader = new FileReader();
                            reader.readAsDataURL(files[0].getNative());
                            reader.onload = (function (e) {
                                var image = new Image();
                                image.src = e.target.result;
                                image.onload = function () {
                                        if (nownum + uploader.files.length > maxPicNum) {
                                            for(var i in files){
                                                uploader.removeFile(files[i].id);
                                            }
                                            alert('多做上传'+maxPicNum+'张');
                                            return;
                                        }
                                        $("#parent"+uploadid).remove();
                                        uploader.start();
                                };
                            });

                            //每个事件监听函数都会传入一些很有用的参数，
                            //我们可以利用这些参数提供的信息来做比如更新UI，提示上传进度等操作
                        });

                        uploader.bind('FileUploaded',function (uploader,files,info) {
                            var response = JSON.parse(info.response);
                            var url = response.url;
                            var str = strpic(url,uploadcontainer);
                            uploader.removeFile(files.id);
                            $("#"+uploadcontainer).append(str);
                        })

                        uploader.bind('UploadComplete', function (uploader, files) {
                            var nownum = $("."+uploadcontainer).length;
                            if (nownum <maxPicNum) {
                                createUploadStr(uploadcontainer,maxPicNum);
                            }
                            uploadpathstr(uploadcontainer);
                            uploader.destroy();
                        })
                    }


                     function addexchangeproduct() {
                         var str ='                <div class="exchangecon">' +
                             '                </div>'+

                             '                <div class="form-group">' +
                             '                <div class="col-sm-3">' +
                             '                <button type="button" name="add" id=""  class="btn btn-primary addexchage" style="width:80px;background:#777;border:0;margin-left:-15px">添加</button>' +
                             '                </div>' +
                             '' +
                             '                </div>';
                         $('#exchange').html(str)
                     }
                     function oneexchagecon(onecon) {
                         var str ='<div class="onecon form-group" >'+
                             '                        <div class="col-sm-8" style="border:1px solid black;padding:20px;">' +
                             '                        <div class="form-group">' +
                             '                        <label for="" class="col-sm-2 control-label" style="margin-left:-10px">*选择产品</label>' +
                             '                        <div class="col-sm-9" class="productselected">' +
                             '                        <select name=""  class="form-control productselect"></select>' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <div class="form-group">' +
                             '                        <div class="col-sm-6" id="">' +
                             '                        <select name="" id="" class="form-control onegoods selectpicker" multiple title="请选择商品">' ;
                         var options = onecon.selectlist;
                            for(var j=0;j<options.length;j++) {
                                str+='<option value="'+options[j].id+'">'+options[j].name+'</option>';
                            }
                            str+= '                        </select>'+
                             '                        </div>' +
                             '                        <div class="col-sm-5" id="" style="margin-left:-11px">' +
                             '                        <input name="" id="" class="form-control exchangenums" placeholder="兑换次数" value="'+onecon.nums+'">' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <div class="form-group">' +
                             '                        <label for="" class="col-sm-2">*显示名称</label>' +
                             '                        <div class="col-sm-9" style="margin-left:-11px">' +
                             '                        <input type="text" class="form-control opentitle"  name="" id="indexselect" placeholder="10字以内，显示在卡包中" value="'+onecon.title+'">' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <img src="__PUBLIC__/Admin/images/u847.png"  class="delselected" alt="点击删除" style="float: right;position: absolute;right: -30px;height: 30px;top:-1px;cursor: pointer" />' +
                             '                        </div></div>';
                         $('.exchangecon').append(str)
                         var that = $('.onecon:last-child .productselect');
                         var thatoncon = $(".onecon:last-child");
                         thatoncon.find('.selectpicker').selectpicker('val',onecon.selects);
                         thatoncon.find('.selectpicker').selectpicker('refresh');
                         var selectdata = [];
                         var selecids = [];
                         selectdata.push({id:onecon.productid,text:onecon.productname});
                         selecids.push(onecon.productid);
                         console.log(selectdata)
                         console.log(selecids)
                         that.select2({
                             placeholder:'请输入产品id或名称',
                             data:selectdata,
                             ajax: {
                                 url: "{:U('chooseAll')}",
                                 dataType: 'json',

                                 delay: 250,
                                 data: function (params) {
                                     return {
                                         key: params.term,
                                         type:4
                                     };
                                 },
                                 processResults: function (data) {
                                     console.log(data);
                                     return {
                                         results: data
                                     };
                                 },
                                 cache: true
                             },
                             escapeMarkup: function (markup) { return markup; },
                             minimumInputLength: 1
                         }).val(selecids).trigger("change");;
                         that.on('select2:select',function (e) {
                             console.log(e.params.data)
                             var productid = e.params.data.id;
                             $.post("{:U('CardApi/Card/getAllgoodsAndSpec')}",{productid:productid},function (info) {
                                 var data = info.data;
                                 var option = '';
                                 for (var j=0;j<data.length;j++) {
                                     option+='<option value="'+data[j].id+'">'+data[j].name+'</option>';
                                 }
                                 thatoncon.find('.selectpicker').html(option);
                                 thatoncon.find('.selectpicker').selectpicker('refresh');
                             },'json')
                         })
                     }
                   //  addexchangeproduct();
                     //oneexchagecon();
                     function cardprice() {                                              //面额
                         var str = '<label for="" class="col-sm-2 control-label" >*礼品卡面额</label><div class="col-sm-2"><input type="text" class="form-control"   name="" placeholder="" id="price"></div><div class="col-sm-1 wenzi">元</div>';
                         $('#cardprice').html(str);
                     }
                     function usearea() {
                         var str ='          <div class="form-group">' +
                             '                  <label for="" class="col-sm-2 control-label" >*可用产品范围</label>' +
                             '                    <div class="col-sm-3">' +
                             '                    <select name="" class="form-control" id="usetype">' +
                             '                        <option value="1">白名单模式（以下产品可用）</option>' +
                             '                        <option value="2">黑名单模式（除以下产品外的产品可用）</option>' +
                             '                    </select>' +
                             '                  </div>' +
                             '               </div>' +
                             '            <div class="form-group">' +
                             '                <label for="" class="col-sm-2 control-label" ></label>' +
                             '                    <div class="col-sm-2 redioType"  >' +
                             '                      <input type="radio" name="secnetype" class="isall" value="1" checked id="allProduct">' +
                             '                      <span>所有产品</span>' +
                             '                    </div>' +
                             '                    <div class="col-sm-2 redioTypeLeft">' +
                             '                        <input type="radio" name="secnetype" class="isall" value="2" id="sectionProduct">' +
                             '                        <span>部分产品</span>' +
                             '                    </div>' +
                             '                </div>' +
                             '                <div  class="form-group"  id="productInfomation"> </div>';
                         $('#usearea').html(str);
                     }
                     function cardurl() {
                         var str = '                  <div class="form-group">' +
                             '                    <label for="" class="col-sm-2 control-label" >跳转链接</label>' +
                             '                    <div class="col-sm-2" id="" style="z-index: 10000">' +
                             '                    <select  name=""  class="form-control" id="urltype">' +
                             '                    <option value="1">无</option>' +
                             '                    <option value="2">首页</option>' +
                             '                    <option value="3">管家页</option>' +
                             '                    <option value="4">产品页</option>' +
                             '                    <option value="5">链接</option>' +
                             '                    </select>' +
                             '                    </div>' +
                             '                    <div class="col-sm-3" id="condition">' +
                             '                    <input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">' +
                             '                    </div>' +
                             '                    </div> ';
                         $('#cardurl').html(str)
                     }

                     //初始化编辑页面信息
                        var type = "{$res.type}";
                        if (type ==2) {
                            addexchangeproduct();
                            var exchangelist = '{$res.exchangelist}';
                            exchangelist = JSON.parse(exchangelist);
                            for (var j =0; j<exchangelist.length;j++) {
                                oneexchagecon(exchangelist[j]);
                            }
                        }


                     function newoneexchagecon() {
                         var str ='<div class="onecon form-group" >'+
                             '                        <div class="col-sm-8" style="border:1px solid black;padding:20px;">' +
                             '                        <div class="form-group">' +
                             '                        <label for="" class="col-sm-2 control-label" style="margin-left:-10px">*选择产品</label>' +
                             '                        <div class="col-sm-9" class="productselected">' +
                             '                        <select name=""  class="form-control productselect"></select>' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <div class="form-group">' +
                             '                        <div class="col-sm-6" id="">' +
                             '                        <select name="" id="" class="form-control onegoods selectpicker" multiple title="请选择商品">' +
                             '                        </select>' +
                             '                        </div>' +
                             '                        <div class="col-sm-5" id="" style="margin-left:-11px">' +
                             '                        <input name="" id="" class="form-control exchangenums" placeholder="兑换次数">' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <div class="form-group">' +
                             '                        <label for="" class="col-sm-2">*显示名称</label>' +
                             '                        <div class="col-sm-9" style="margin-left:-11px">' +
                             '                        <input type="text" class="form-control opentitle"  name="" id="indexselect" placeholder="10字以内，显示在卡包中">' +
                             '                        </div>' +
                             '                        </div>' +
                             '                        <img src="__PUBLIC__/Admin/images/u847.png"  class="delselected" alt="点击删除" style="float: right;position: absolute;right: -30px;height: 30px;top:-1px;cursor: pointer" />' +
                             '                        </div></div>';
                         $('.exchangecon').append(str)
                         var that = $('.onecon:last-child .productselect');
                         var thatoncon = $(".onecon:last-child");
                         thatoncon.find('.selectpicker').selectpicker('refresh');

                         that.select2({
                             placeholder:'请输入产品id或名称',
                             ajax: {
                                 url: "{:U('chooseAll')}",
                                 dataType: 'json',
                                 delay: 250,
                                 data: function (params) {
                                     return {
                                         key: params.term,
                                         type:4
                                     };
                                 },
                                 processResults: function (data) {
                                     console.log(data);
                                     return {
                                         results: data
                                     };
                                 },
                                 cache: true
                             },
                             escapeMarkup: function (markup) { return markup; },
                             minimumInputLength: 1
                         });
                         that.on('select2:select',function (e) {
                             console.log(e.params.data)
                             var productid = e.params.data.id;
                             $.post("{:U('CardApi/Card/getAllgoodsAndSpec')}",{productid:productid},function (info) {
                                 var data = info.data;
                                 var option = '';
                                 for (var j=0;j<data.length;j++) {
                                     option+='<option value="'+data[j].id+'">'+data[j].name+'</option>';
                                 }
                                 thatoncon.find('.selectpicker').html(option);
                                 thatoncon.find('.selectpicker').selectpicker('refresh');
                             },'json')
                         })
                     }
                        //添加一个兑换产品
                     $('#exchange').on('click','.addexchage',function () {
                         newoneexchagecon();
                     })
                     //删除一个所选产品
                     $('#exchange').on('click','.delselected',function () {
                         var length = $(".onecon").length;
                         if(length<2){
                             alert("您已不能删除");
                         }else{
                             $(this).parent().parent().remove();
                         }

                     })



                     var cardtype = "{$cardurl.type}"
                    var cardtvalue = "{$cardurl.value}"
                    var urlid = "{$cardurl.id}"
                    init(cardtype, cardtvalue,urlid)
                    function init(type, value,urlid) {
                        var inputstr = '';
                        if (type ==1) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">';
                        } else if (type == 2) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">';
                        }else if(type==3){
                            inputstr='<select class="js-example-basic-multiple col-sm-12" id="guanjiaselect" name="urltvalue" multiple="multiple"></select>';
                        }else if(type==4){
                            inputstr='<select class="js-example-basic-multiple col-sm-12" id="productselect" name="urltvalue" multiple="multiple"></select>';
                        }else if (type == 5) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="输入链接地址" value="'+value+'">';
                        }
                        $("#condition").html(inputstr);
                        selects(type,value,urlid)
                    }
                    function selects(type,value,id) {
                        var data = [];
                        var ids= [];
                        data.push({id:id,text:value});
                        ids.push(id)
                        console.log(ids)
                        if (type == 4) {
                            $('#productselect').select2({
                                placeholder:'请输入产品id或名称',
                                data:data,
                                ajax: {
                                    url: "{:U('chooseAll')}",
                                    dataType: 'json',
                                    delay: 250,
                                    data: function (params) {
                                        return {
                                            key: params.term,
                                            type:type
                                        };
                                    },
                                    processResults: function (data) {
                                        console.log(data);
                                        return {
                                            results: data
                                        };
                                    },
                                    cache: true
                                },
                                escapeMarkup: function (markup) { return markup; },
                                minimumInputLength: 1
                            }).val(ids).trigger("change");
                        } else if(type == 3) {
                            $('#guanjiaselect').select2({
                                placeholder:'请输入管家id或名称',
                                data:data,
                                ajax: {
                                    url: "{:U('chooseAll')}",
                                    dataType: 'json',
                                    delay: 250,
                                    data: function (params) {
                                        return {
                                            key: params.term,
                                            type:type
                                        };
                                    },
                                    processResults: function (data) {
                                        console.log(data);
                                        return {
                                            results: data
                                        };
                                    },
                                    cache: true
                                },
                                escapeMarkup: function (markup) { return markup; },
                                minimumInputLength: 1
                            }).val(ids).trigger("change");
                        }

                    }
                    function selects1(type) {
                        if (type == 4) {
                            $('#productselect').select2({
                                placeholder:'请输入产品id或名称',
                                ajax: {
                                    url: "{:U('chooseAll')}",
                                    dataType: 'json',
                                    delay: 250,
                                    data: function (params) {
                                        return {
                                            key: params.term,
                                            type:type
                                        };
                                    },
                                    processResults: function (data) {
                                        console.log(data);
                                        return {
                                            results: data
                                        };
                                    },
                                    cache: true
                                },
                                escapeMarkup: function (markup) { return markup; },
                                minimumInputLength: 1
                            });
                        } else if(type == 3) {
                            $('#guanjiaselect').select2({
                                placeholder:'请输入管家id或名称',
                                ajax: {
                                    url: "{:U('chooseAll')}",
                                    dataType: 'json',
                                    delay: 250,
                                    data: function (params) {
                                        return {
                                            key: params.term,
                                            type:type
                                        };
                                    },
                                    processResults: function (data) {
                                        console.log(data);
                                        return {
                                            results: data
                                        };
                                    },
                                    cache: true
                                },
                                escapeMarkup: function (markup) { return markup; },
                                minimumInputLength: 1
                            });
                        }

                    }
                    $('#urltype').change(function () {
                        var type = $(this).val();
                        var inputstr = '';
                        if (type ==1) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">';
                        } else if (type == 2) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="无需输入任何内容">';
                        }else if(type==3){
                            inputstr='<select class="js-example-basic-multiple col-sm-12" id="guanjiaselect" name="urltvalue" multiple="multiple"></select>';
                        }else if(type==4){
                            inputstr='<select class="js-example-basic-multiple col-sm-12" id="productselect" name="urltvalue" multiple="multiple"></select>';
                        }else if (type == 5) {
                            inputstr='<input type="text" class="form-control"  name="" id="indexselect" placeholder="输入链接地址">';
                        }
                        $("#condition").html(inputstr);
                        selects1(type)
                    })

                </script>
                <script>

                    $("#usetype").change(function () {
                        var useType = $(this).val();
                        if (useType == 2) {
                            $("#allProduct").prop('disabled',true);
                            $("#sectionProduct").prop('checked',true);
                            addproductinfomation();
                        } else {
                            $("#allProduct").prop('disabled',false);
                        }
                    })



                    $(document).ready(() => {
                        window.ueditorXsetContent({
                        notes: `{$res.desc}`
                    });
                    });

                    <?php if($res['isall'] == 2){?>
                        $('#serachvalue').select2({
                            placeholder:'',
                            ajax: {
                                url: "<?=U('CouponApi/Coupon/serachValeByType') ?>",
                                dataType: 'json',
                                delay: 250,
                                data: function (params) {
                                    return {
                                        value: params.term,
                                        type:$("#selecttype").val()
                                    };
                                },
                                processResults: function (data) {
                                    return {
                                        results: data
                                    };
                                },
                                cache: true
                            },
                            escapeMarkup: function (markup) { return markup; },
                            minimumInputLength: 1
                        });
                    <?php }?>



                    /*选择可用产品*/
                    function productinfomation(){
                        var str='  <div class="form-group" >\n' +
                            '                <label for="" class="col-sm-2 control-label" ></label>\n' +
                            '                <div class="col-sm-2">\n' +
                            '                    <select  name="type"  class="form-control" id="selecttype">\n' +
                            '                        <option value="1">一级分类</option>\n' +
                            '                        <option value="2">二级分类</option>\n' +
                            '                        <option value="3">管家</option>\n' +
                            '                        <option value="4">产品</option>\n' +
                            '                        <option value="5">供应商</option>\n' +
                            '                    </select>\n' +
                            '                </div>\n' +
                            '                <div class="col-sm-3">\n' +
                            '                    <select name="" id="serachvalue" class="form-control"></select>\n' +
                            '                </div>\n' +
                            '                <div class="col-sm-1">\n' +
                            '                    <button type="button" name="" id="addButton" class="btn btn-primary sureButton" style="width:50px;background:#1AB394;border:0">添加</button>\n' +
                            '                </div>\n' +
                            '            </div>\n' +
                            '            <label for="" class="col-sm-2 control-label" ></label>\n' +
                            '            <div class="selectCondition" id="selectCondition"></div>';
                        return str;
                    }

                    function addproductinfomation(){
                        var str='';
                        str=productinfomation();
                        $("#productInfomation").html(str);
                        $('#serachvalue').select2({
                            placeholder:'',
                            ajax: {
                                url: "{:U('CouponApi/Coupon/serachValeByType')}",
                                dataType: 'json',
                                delay: 250,
                                data: function (params) {
                                    return {
                                        value: params.term,
                                        type:$("#selecttype").val()
                                    };
                                },
                                processResults: function (data) {
                                    return {
                                        results: data
                                    };
                                },
                                cache: true
                            },
                            escapeMarkup: function (markup) { return markup; },
                            minimumInputLength: 1
                        });
                    }
                    $("#sectionProduct").click(function(){
                        addproductinfomation();
                    })

                    $("#allProduct").click(function(){
                        $("#productInfomation").html('');
                    })

                    $("#productInfomation").on('click','#addButton',function(){
                        var data = $('#serachvalue').select2('val');
                        var str = '';
                        var type = 0;
                        var name = '';
                        var id = 0;
                        if (data) {
                            data = data.split(',')
                            id = data[0];
                            name = data[1];
                            type = data[2];
                            var tag = type+'-'+id;
                            var length = $(".selectItem[data-tag='"+tag+"']").length
                            if (!length) {
                                str += $("#selecttype option[value='"+type+"']").text()+':'+name;
                                str='<div class="item selectItem" data-id="'+id+'" data-name="'+name+'" data-type="'+type+'" data-tag="'+tag+'">'+str+' <span class="delButton">×</span></div>';
                                $("#selectCondition").append(str);
                            }
                            $("#serachvalue").empty();
                        }

                    })

                    /*删除一个筛选产品条件*/
                    $("#productInfomation").on('click','.delButton',function(){
                        $(this).parents('.selectItem').remove();
                    })

                    var newDate = new Date();
                    Date.prototype.format = function(format) {
                        var date = {
                            "M+": this.getMonth() + 1,
                            "d+": this.getDate(),
                            "h+": this.getHours(),
                            "m+": this.getMinutes(),
                            "s+": this.getSeconds(),
                            "q+": Math.floor((this.getMonth() + 3) / 3),
                            "S+": this.getMilliseconds()
                        };
                        if (/(y+)/i.test(format)) {
                            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
                        }
                        for (var k in date) {
                            if (new RegExp("(" + k + ")").test(format)) {
                                format = format.replace(RegExp.$1, RegExp.$1.length == 1
                                    ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
                            }
                        }
                        return format;
                    }
                    var nowdate = newDate.format('yyyy-MM-dd h:m:s');

                   /*修改礼品卡信息*/

                    $("#surebtn").click(function(){
                        var type= $(".cardType:checked").val();
                        var id="{$Think.get.id}";
                        var cardpic='';
                        var exchangelist='';
                        var titleis = true;
                        var exchangeid = 0;
                        if(type==1){
                            cardpic='';
                            exchangelist='';
                        }else{
                            cardpic=$("#imgcontainer").attr('uploadpath');
                            console.log('11111111');
                            console.log(cardpic);
                            exchangelist = [];
                            $('.onecon').each(function(){
                                var id=exchangeid;
                                var productid='';
                                var product = $(this).find('.productselect').select2('data')[0];
                                if(product){
                                    productid = product.id ;
                                }
                                var selects=$(this).find('.selectpicker').val();
                                var nums = $(this).find('.exchangenums').val();
                                var title = $(this).find('.opentitle').val();
                                var oneobject = {};
                                oneobject.id = id;
                                oneobject.productid= productid;
                                oneobject.selects = selects;
                                oneobject.nums = nums;
                                oneobject.title = title;
                                exchangelist.push(oneobject)
                                if (title.length >10) {
                                    titleis = false;
                                }
                                exchangeid ++;
                            })
                            exchangelist = JSON.stringify(exchangelist);
                        }
                        var name=$("#name").val();
                        var desc = notesEditor.getContent();
                        if(type==1){
                            var usetype = $("#usetype").val();
                            var isall = $(".isall:checked").val();
                            var productids='';
                            var levelones='';
                            var leveltwos='';
                            var guanjiaids='';
                            var supplierids='';
                            $('.selectItem').each(function(){
                                var type = $(this).attr('data-type');
                                if(type==1){
                                    levelones+='-'+$(this).attr('data-id');
                                }else if(type==2){
                                    leveltwos+='-'+$(this).attr('data-id');
                                }else if(type==3){
                                    guanjiaids+='-'+$(this).attr('data-id');
                                }else if(type==4){
                                    productids+='-'+$(this).attr('data-id');
                                }else{
                                    supplierids+='-'+$(this).attr('data-id');
                                }
                            })
                            if(levelones){
                                levelones=levelones+'-';
                            }
                            if(leveltwos){
                                leveltwos=leveltwos+'-';
                            }
                            if(guanjiaids){
                                guanjiaids=guanjiaids+'-';
                            }
                            if(productids){
                                productids=productids+'-';
                            }
                            if(supplierids){
                                supplierids=supplierids+'-';
                            }
                            var urltype=$("#urltype option:selected").val();
                            var urlvalue='';
                            if(urltype==3 || urltype==4) {
                                var urltvalues = $('.js-example-basic-multiple').select2('data');
                                if (urltvalues.length > 0) {
                                    urltvalue=urltvalues[0].id;
                                }
                            }
                            else{
                                urltvalue = $("#indexselect").val();
                            }

                            var cardurl=urltype+';'+urltvalue;
                        }

                        var info=$("#info").val();
                        var status = $(".status:checked").val();
                        // var parnt = /^[0-9]\d*(\.\d+)?$/;
                        var parnt = /^[1-9]*[1-9][0-9]*$/;
                        var smallNums = /^0\.([0-9]){1,2}$/;
                        var fenshu =/^[1-9]*[1-9][0-9]*$/;

                        if(!name){
                            window.alert('请输入礼品卡名称');
                        }else if(name.length>15){
                            window.alert('请输入正确的礼品卡名称');
                        } else if(!desc){
                            window.alert('请输入规则描述');
                        }else if(isall==2 && (!levelones && !leveltwos && !guanjiaids && !productids && !supplierids)){
                            window.alert('请选择产品');
                        }else if (!titleis) {
                            window.alert('兑换产品的名称不能超过10个字')
                        }else if(!info){
                            window.alert('请输入礼品卡用途');
                        }else if(!status){
                            window.alert('请选择礼品卡状态');
                        }else{
                            $.post("{:U('CardApi/Card/updateCard')}",
                                {
                                    type:type,
                                    id:id,
                                    name:name,
                                    desc:desc,
                                    usetype:usetype,
                                    isall:isall,
                                    levelones:levelones,
                                    leveltwos:leveltwos,
                                    guanjiaids:guanjiaids,
                                    productids:productids,
                                    supplierids:supplierids,
                                    info:info,
                                    status:status,
                                    cardurl:cardurl,
                                    cardpic:cardpic,
                                    exchangelist:exchangelist
                                },
                                function(res){
                                    if(res.state==1){
                                        alert(res.msg);
                                         window.location.href="{:U('OperationGiftCard/index')}";
                                    }else{
                                        alert(res.msg);
                                    }
                                },
                                'json'
                            );
                        }

                    })
                </script>

</body>
</html>